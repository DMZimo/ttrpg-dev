---
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import FormattedDate from "@/components/layout/FormattedDate.astro";
import { Image } from "astro:assets";

type Props = CollectionEntry<"journal">["data"];

const {
  title,
  description,
  session_title,
  session_number,
  session_date,
  duration,
  characters_involved,
  npcs_encountered,
  previous_session,
  next_session,
  tags,
  pubDate,
  updatedDate,
  heroImage,
} = Astro.props;

// Use session_title if available, otherwise fall back to title
const displayTitle =
  session_title || title || `Session ${session_number || ""}`;
const displayDate = session_date || pubDate;
---

<BaseLayout
  title={displayTitle}
  description={description || ""}
  image={heroImage}
  class="max-w-none"
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {
      heroImage && (
        <div class="hero-image mb-12">
          <Image
            src={heroImage}
            alt={displayTitle}
            class="w-full h-80 md:h-96 object-cover rounded-2xl shadow-card border border-primary"
          />
        </div>
      )
    }

    <div class="prose prose-lg max-w-none mx-auto">
      <header class="mb-12 text-center border-b border-primary pb-12">
        {
          session_number && (
            <div class="session-number text-sm font-bold text-accent-600 mb-3 px-4 py-2 bg-accent-50 rounded-full inline-block border border-accent-200">
              Session {session_number}
            </div>
          )
        }
        <h1 class="title text-5xl font-bold text-primary mb-6 leading-tight">
          {displayTitle}
        </h1>
        {
          displayDate && (
            <div class="date text-secondary mb-3 text-lg">
              <FormattedDate date={displayDate} />
            </div>
          )
        }
        {
          duration && (
            <div class="duration text-tertiary">
              Duration: <FormattedDate date={duration} />
            </div>
          )
        }
        {
          updatedDate && (
            <div class="last-updated-on text-tertiary mt-4 text-sm">
              Last updated on <FormattedDate date={updatedDate} />
            </div>
          )
        }
      </header>

      <!-- Session Metadata -->
      {
        (characters_involved || npcs_encountered || tags) && (
          <div class="session-metadata bg-surface-elevated rounded-2xl p-8 mb-12 not-prose shadow-card border border-primary">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
              {characters_involved && characters_involved.length > 0 && (
                <div class="characters">
                  <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <span class="text-2xl">üë•</span>
                    <span>Characters Involved</span>
                  </h3>
                  <ul class="space-y-2">
                    {characters_involved.map((character) => (
                      <li class="text-secondary flex items-center gap-2">
                        <span class="w-2 h-2 bg-accent-400 rounded-full" />
                        {character.replace(/\[\[|\]\]/g, "")}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {npcs_encountered && npcs_encountered.length > 0 && (
                <div class="npcs">
                  <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <span class="text-2xl">üèòÔ∏è</span>
                    <span>NPCs Encountered</span>
                  </h3>
                  <ul class="space-y-2">
                    {npcs_encountered.map((npc) => (
                      <li class="text-secondary flex items-center gap-2">
                        <span class="w-2 h-2 bg-gold-400 rounded-full" />
                        {npc.replace(/\[\[|\]\]/g, "")}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {tags && tags.length > 0 && (
                <div class="tags">
                  <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2">
                    <span class="text-2xl">üè∑Ô∏è</span>
                    <span>Tags</span>
                  </h3>
                  <div class="flex flex-wrap gap-2">
                    {tags.map((tag) => (
                      <span
                        class="tag px-3 py-1 text-sm font-medium rounded-full border transition-colors hover:scale-105"
                        style="background: rgba(var(--accent-100), 0.5); color: rgb(var(--accent-700)); border-color: rgba(var(--accent-300), 0.5);"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )
      }

      <!-- Session Content -->
      <div class="prose prose-xl max-w-none text-secondary">
        <slot />
      </div>

      <!-- Session Navigation -->
      {
        (previous_session || next_session) && (
          <div class="session-navigation mt-16 pt-12 border-t border-primary">
            <div class="nav-links flex justify-between">
              {previous_session ? (
                <a
                  href={`/journal/${previous_session
                    .replace(/\[\[|\]\]/g, "")
                    .toLowerCase()
                    .replace(/\s+/g, "-")}`}
                  class="prev-session group bg-surface-elevated hover:bg-surface-tertiary text-primary px-6 py-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-card hover:shadow-card-hover border border-primary hover:border-accent-400 hover:scale-105"
                >
                  <svg
                    class="w-6 h-6 group-hover:-translate-x-1 transition-transform"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <div>
                    <div class="font-semibold">Previous Session</div>
                    <div class="text-sm text-secondary">
                      {previous_session.replace(/\[\[|\]\]/g, "")}
                    </div>
                  </div>
                </a>
              ) : (
                <div />
              )}

              {next_session && (
                <a
                  href={`/journal/${next_session
                    .replace(/\[\[|\]\]/g, "")
                    .toLowerCase()
                    .replace(/\s+/g, "-")}`}
                  class="next-session group bg-surface-elevated hover:bg-surface-tertiary text-primary px-6 py-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-card hover:shadow-card-hover border border-primary hover:border-accent-400 hover:scale-105"
                >
                  <div class="text-right">
                    <div class="font-semibold">Next Session</div>
                    <div class="text-sm text-secondary">
                      {next_session.replace(/\[\[|\]\]/g, "")}
                    </div>
                  </div>
                  <svg
                    class="w-6 h-6 group-hover:translate-x-1 transition-transform"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </a>
              )}
            </div>
          </div>
        )
      }
    </div>
  </article>
</BaseLayout>
