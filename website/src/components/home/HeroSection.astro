---
import { getCollection } from "astro:content";

// Import assets
import blogPlaceholder1 from "../../assets/blog-placeholder-1.jpg";
import blogPlaceholder1Holo from "../../assets/blog-placeholder-1-holo.jpg";
import blogPlaceholder2 from "../../assets/blog-placeholder-2.jpg";
import blogPlaceholder2Holo from "../../assets/blog-placeholder-2-holo.jpg";
import blogPlaceholder3 from "../../assets/blog-placeholder-3.jpg";
import blogPlaceholder3Holo from "../../assets/blog-placeholder-3-holo.jpg";

// Get campaign stats
const allSessions = (await getCollection("journal")).sort((a, b) => {
  const dateA = a.data.session_date || a.data.pubDate;
  const dateB = b.data.session_date || b.data.pubDate;

  if (!dateA && !dateB) return 0;
  if (!dateA) return 1;
  if (!dateB) return -1;

  return dateB.valueOf() - dateA.valueOf();
});

const totalSessions = allSessions.length;
const latestSession = allSessions[0];

// Get unique tags
const allTags = new Set<string>();
allSessions.forEach((session) => {
  if (session.data.tags) {
    session.data.tags.forEach((tag: string) => allTags.add(tag));
  }
});

// Find next upcoming session (look for sessions with future dates)
const today = new Date();
const upcomingSession = allSessions.find((session) => {
  const sessionDate = session.data.session_date;
  return sessionDate && sessionDate > today;
});

// Format date helper
const formatDate = (date: Date) => {
  return date.toLocaleDateString("en-US", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

// Placeholder for Discord webhook data
const nextDiscordSession = {
  title: "Session 4 - The Goblin Ambush",
  date: new Date("2025-06-30T19:00:00"),
  description:
    "Join us for our next adventure as we explore the mysterious caves near Triboar!",
  players: ["Oliver", "Aldor", "Daijo", "Finn"],
};

const isDiscordSessionUpcoming = nextDiscordSession.date > today;
---

<section
  class="hero-section w-full min-h-[calc(100vh-4rem)] bg-surface sharp-corners flex flex-col"
>
  <!-- Hero Grid Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 flex-1">
    <!-- Latest Journal Entry - Large Featured Card -->
    <div
      class="lg:col-span-2 relative overflow-hidden min-h-[calc(100vh-8rem)] holo-container"
      data-holo-image="blog-placeholder-1"
      style={`--holo-mask: url('${blogPlaceholder1Holo.src}');`}
    >
      <div
        class="absolute inset-0 bg-cover bg-center"
        style={`background-image: linear-gradient(135deg, rgba(28, 28, 39, 0.8) 0%, rgba(39, 39, 55, 0.6) 100%), url('${blogPlaceholder1.src}');`}
      >
      </div>

      <div class="relative h-full flex flex-col justify-end p-8 lg:p-12">
        <div
          class="bg-surface/90 backdrop-blur-sm p-6 lg:p-8 border-l-4 border-ddb-red"
        >
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-ddb-red flex items-center justify-center">
              <span class="text-white font-bold text-lg">üìñ</span>
            </div>
            <span
              class="text-sm uppercase tracking-wider text-ddb-red font-semibold"
              >Latest Adventure</span
            >
          </div>

          {
            latestSession && (
              <>
                <h2 class="text-3xl lg:text-4xl font-bold text-primary mb-4 leading-tight">
                  {latestSession.data.session_title ||
                    `Session ${latestSession.data.session_number}`}
                </h2>
                <p class="text-lg text-secondary mb-6 leading-relaxed">
                  {latestSession.data.description ||
                    "Our latest adventure in the Dessarin Valley unfolds with danger and discovery..."}
                </p>
                <div class="flex items-center justify-between">
                  <div class="text-sm text-muted">
                    {latestSession.data.session_date
                      ? formatDate(latestSession.data.session_date)
                      : "Recently"}
                  </div>
                  <a
                    href={`/journal/${latestSession.id}`}
                    class="ddb-button-primary px-6 py-3 inline-flex items-center gap-2 hover:gap-3 transition-all"
                  >
                    <span>Read Full Chronicle</span>
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 7l5 5m0 0l-5 5m5-5H6"
                      />
                    </svg>
                  </a>
                </div>
              </>
            )
          }
        </div>
      </div>
    </div>

    <!-- Sidebar with Next Session and Atlas -->
    <div
      class="lg:col-span-1 bg-surface-secondary border-l border-primary min-h-[calc(100vh-8rem)]"
    >
      <!-- Next Session Card -->
      <div
        class="h-1/2 border-b border-primary relative overflow-hidden holo-container"
        data-holo-image="blog-placeholder-2"
        style={`--holo-mask: url('${blogPlaceholder2Holo.src}');`}
      >
        <div
          class="absolute inset-0 bg-cover bg-center opacity-20"
          style={`background-image: url('${blogPlaceholder2.src}');`}
        >
        </div>

        <div class="relative h-full flex flex-col justify-center p-6 lg:p-8">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-8 h-8 bg-accent-600 flex items-center justify-center">
              <span class="text-white font-bold">üóìÔ∏è</span>
            </div>
            <span
              class="text-sm uppercase tracking-wider text-accent-600 font-semibold"
              >Next Session</span
            >
          </div>

          {
            isDiscordSessionUpcoming ? (
              <>
                <h3 class="text-xl font-bold text-primary mb-3 leading-tight">
                  {nextDiscordSession.title}
                </h3>
                <div class="space-y-3 mb-6">
                  <div class="flex items-center gap-2 text-secondary">
                    <span class="w-4 h-4">üìÖ</span>
                    <span class="text-sm">
                      {formatDate(nextDiscordSession.date)}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 text-secondary">
                    <span class="w-4 h-4">üë•</span>
                    <span class="text-sm">
                      {nextDiscordSession.players.length} Adventurers
                    </span>
                  </div>
                  <div class="flex items-center gap-2 text-secondary">
                    <span class="w-4 h-4">üí¨</span>
                    <span class="text-sm">Discord Integration</span>
                  </div>
                </div>
                <p class="text-sm text-muted mb-4">
                  {nextDiscordSession.description}
                </p>
              </>
            ) : (
              <>
                <h3 class="text-xl font-bold text-primary mb-3">
                  Planning Next Adventure
                </h3>
                <p class="text-sm text-secondary mb-4">
                  Our next session is being scheduled. Join our Discord server
                  for real-time updates and coordination.
                </p>
                <div class="flex items-center gap-2 text-secondary mb-4">
                  <span class="w-4 h-4">üí¨</span>
                  <span class="text-sm">Check Discord for Updates</span>
                </div>
              </>
            )
          }

          <button class="ddb-button-secondary w-full py-2 text-sm">
            Join Discord Server
          </button>
        </div>
      </div>

      <!-- Atlas/Map Card -->
      <div
        class="h-1/2 relative overflow-hidden holo-container"
        data-holo-image="blog-placeholder-3"
        style={`--holo-mask: url('${blogPlaceholder3Holo.src}');`}
      >
        <div
          class="absolute inset-0 bg-cover bg-center opacity-30"
          style={`background-image: url('${blogPlaceholder3.src}');`}
        >
        </div>

        <div class="relative h-full flex flex-col justify-center p-6 lg:p-8">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-8 h-8 bg-gold-600 flex items-center justify-center">
              <span class="text-white font-bold">üó∫Ô∏è</span>
            </div>
            <span
              class="text-sm uppercase tracking-wider text-gold-600 font-semibold"
              >World Atlas</span
            >
          </div>

          <h3 class="text-xl font-bold text-primary mb-3 leading-tight">
            Explore the Dessarin Valley
          </h3>

          <p class="text-sm text-secondary mb-6">
            Discover locations, track your journey, and uncover the secrets of
            our campaign world through our interactive map.
          </p>

          <div class="space-y-2 mb-6">
            <div class="flex items-center gap-2 text-secondary">
              <span class="w-4 h-4">üè∞</span>
              <span class="text-sm">{totalSessions} Locations Visited</span>
            </div>
            <div class="flex items-center gap-2 text-secondary">
              <span class="w-4 h-4">üîç</span>
              <span class="text-sm">{allTags.size} Points of Interest</span>
            </div>
          </div>

          <a
            href="/atlas"
            class="ddb-button-primary w-full py-3 text-center inline-flex items-center justify-center gap-2"
          >
            <span>Explore Map</span>
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7"
              ></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</section>
