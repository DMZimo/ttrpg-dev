---
import { SITE_TITLE } from "@/consts";
import { calculateCampaignStats } from "@/utils/campaignUtils";

interface Props {
  currentPath?: string;
}

const { currentPath = "/" } = Astro.props;

// Calculate campaign stats
let campaignStats;
try {
  campaignStats = await calculateCampaignStats();
} catch (error) {
  // Fallback stats
  campaignStats = {
    totalSessions: 4,
    totalCharacters: 4,
    totalNPCs: 12,
    totalQuests: 8,
    activeQuests: 3,
    completedQuests: 5,
    totalMysteries: 2,
    activeMysteries: 1,
    totalRumors: 6,
    activePlayers: 4,
    currentLevel: 3,
    totalPlayTime: 14.5,
    averageSessionLength: 3.6,
    combatEncounters: 6,
    deathSaves: 2,
    criticalHits: 15,
    questCompletionRate: 62.5,
    mysteryResolutionRate: 50,
  };
}

// Navigation items with their routes based on the actual workspace structure
const navigationItems = [
  {
    href: "/journal",
    label: "Journal",
    description: "Session logs and adventures",
  },
  {
    href: "/campaign",
    label: "Campaign",
    description: "Quests, mysteries, and progress",
  },
  { href: "/atlas", label: "Atlas", description: "Maps and locations" },
  { href: "/calendar", label: "Calendar", description: "Timeline and events" },
  {
    href: "/characters",
    label: "Characters",
    description: "Player characters and NPCs",
  },
];

// Helper function to check if a nav item is active
const isActive = (href: string) => {
  if (href === "/" && currentPath === "/") return true;
  if (href !== "/" && currentPath.startsWith(href)) return true;
  return false;
};
---

<header
  class="fixed top-0 left-0 right-0 z-40 bg-surface/95 backdrop-blur-md border-b border-border-primary transition-all duration-300"
>
  <!-- Main Navigation Bar -->
  <nav
    class="px-6 h-14 flex items-center justify-between w-full max-w-7xl mx-auto"
  >
    <!-- Brand Section -->
    <div class="flex-shrink-0">
      <a
        href="/"
        class="flex items-center gap-3 font-bold text-lg text-text-primary hover:text-accent-400 transition-colors group"
      >
        <img
          src="/logo.webp"
          alt="Campaign Logo"
          class="w-7 h-7 object-contain drop-shadow-sm transition-all duration-200 group-hover:scale-105"
        />
        <span class="transition-colors">
          {SITE_TITLE}
        </span>
      </a>
    </div>

    <!-- Main Navigation -->
    <div class="hidden md:flex items-center justify-center flex-1">
      <nav class="flex items-center gap-1">
        {
          navigationItems.map((item) => (
            <a
              href={item.href}
              class={`
                px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 relative
                ${
                  isActive(item.href)
                    ? "text-accent-400 bg-surface-elevated"
                    : "text-text-secondary hover:text-text-primary hover:bg-surface-secondary"
                }
              `}
              title={item.description}
            >
              {item.label}
              {isActive(item.href) && (
                <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-accent-400" />
              )}
            </a>
          ))
        }
      </nav>
    </div>

    <!-- Campaign Stats & Actions -->
    <div class="flex items-center gap-3">
      <!-- Campaign Stats (Desktop) -->
      <div class="hidden lg:flex items-center gap-3 text-xs">
        <a
          href="/campaign"
          class="flex items-center gap-3 px-3 py-2 rounded-lg bg-surface-elevated/50 border border-border-primary hover:bg-surface-elevated hover:border-border-secondary transition-all duration-200 group"
          title="View campaign dashboard"
        >
          <!-- Sessions -->
          <div class="flex items-center gap-1.5">
            <div class="w-1.5 h-1.5 bg-accent-400 rounded-full"></div>
            <div class="flex flex-col">
              <span
                class="font-semibold text-text-primary text-xs leading-none"
              >
                {campaignStats.totalSessions}
              </span>
              <span class="text-[10px] text-text-muted leading-none"
                >Sessions</span
              >
            </div>
          </div>

          <div class="w-px h-4 bg-border-primary"></div>

          <!-- Level -->
          <div class="flex items-center gap-1.5">
            <div class="w-1.5 h-1.5 bg-gold-400 rounded-full"></div>
            <div class="flex flex-col">
              <span class="font-semibold text-gold-400 text-xs leading-none">
                L{campaignStats.currentLevel}
              </span>
              <span class="text-[10px] text-text-muted leading-none">Level</span
              >
            </div>
          </div>

          <div class="w-px h-4 bg-border-primary"></div>

          <!-- Active Quests -->
          <div class="flex items-center gap-1.5">
            <div class="w-1.5 h-1.5 bg-success rounded-full"></div>
            <div class="flex flex-col">
              <span
                class="font-semibold text-text-primary text-xs leading-none"
              >
                {campaignStats.activeQuests}
              </span>
              <span class="text-[10px] text-text-muted leading-none"
                >Quests</span
              >
            </div>
          </div>

          <!-- Hover indicator -->
          <div
            class="opacity-0 group-hover:opacity-60 transition-opacity text-xs text-text-muted ml-1"
          >
            â†’
          </div>
        </a>
      </div>

      <!-- Search Button -->
      <button
        id="search-trigger"
        class="p-2.5 bg-surface-elevated border border-border-primary rounded-lg text-text-tertiary hover:text-text-primary hover:bg-surface-tertiary hover:border-border-focus transition-all duration-200"
        aria-label="Search"
        title="Search campaigns, characters, sessions..."
      >
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
          <path
            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
          ></path>
        </svg>
      </button>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-trigger"
        class="md:hidden p-2.5 bg-surface-elevated border border-border-primary rounded-lg text-text-tertiary hover:text-text-primary hover:bg-surface-tertiary transition-all duration-200"
        aria-label="Open mobile menu"
      >
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
          <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path>
        </svg>
      </button>
    </div>
  </nav>

  <!-- Mobile Navigation (Hidden by default) -->
  <div
    id="mobile-menu"
    class="md:hidden hidden border-t border-border-primary bg-surface/98 backdrop-blur-md"
  >
    <nav class="px-6 py-4 space-y-2">
      {
        navigationItems.map((item) => (
          <a
            href={item.href}
            class={`
              block px-4 py-3 rounded-lg font-medium text-sm transition-all duration-200
              ${
                isActive(item.href)
                  ? "text-accent-400 bg-surface-elevated border-l-2 border-accent-400"
                  : "text-text-secondary hover:text-text-primary hover:bg-surface-secondary"
              }
            `}
          >
            <div class="font-medium">{item.label}</div>
            <div class="text-xs text-text-muted mt-0.5">{item.description}</div>
          </a>
        ))
      }

      <!-- Mobile Campaign Stats -->
      <div class="pt-3 mt-3 border-t border-border-primary">
        <a
          href="/campaign"
          class="block px-4 py-3 rounded-lg bg-surface-elevated border border-border-primary hover:bg-surface-tertiary transition-all duration-200"
        >
          <div class="text-sm font-medium text-text-primary mb-2">
            Campaign Progress
          </div>
          <div class="grid grid-cols-3 gap-3 text-xs">
            <div class="text-center">
              <div class="font-semibold text-text-primary">
                {campaignStats.totalSessions}
              </div>
              <div class="text-text-muted">Sessions</div>
            </div>
            <div class="text-center">
              <div class="font-semibold text-gold-400">
                L{campaignStats.currentLevel}
              </div>
              <div class="text-text-muted">Level</div>
            </div>
            <div class="text-center">
              <div class="font-semibold text-text-primary">
                {campaignStats.activeQuests}
              </div>
              <div class="text-text-muted">Quests</div>
            </div>
          </div>
        </a>
      </div>
    </nav>
  </div>

  <!-- Search Overlay (Hidden by default) -->
  <div
    id="search-overlay"
    class="hidden fixed inset-0 z-[1002] bg-surface/98 backdrop-blur-md"
  >
    <div class="max-w-2xl mx-auto p-8 pt-20">
      <form id="search-form" class="relative mb-8">
        <div class="relative">
          <svg
            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-text-muted"
            viewBox="0 0 24 24"
            width="20"
            height="20"
            fill="currentColor"
          >
            <path
              d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
            ></path>
          </svg>
          <input
            id="search-input"
            type="text"
            placeholder="Search campaigns, characters, sessions..."
            class="w-full pl-12 pr-12 py-4 bg-surface-elevated border-2 border-border-primary rounded-xl text-text-primary text-lg focus:outline-none focus:border-border-focus focus:ring-4 focus:ring-accent-400/20 transition-all duration-200"
          />
          <button
            type="button"
            id="search-close"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 text-text-muted hover:text-text-primary p-1 rounded transition-colors"
            aria-label="Close search"
          >
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path
                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
              ></path>
            </svg>
          </button>
        </div>
      </form>

      <div
        class="bg-surface-elevated border border-border-primary rounded-xl p-6"
      >
        <div class="mb-4">
          <h4
            class="text-text-muted text-sm font-semibold uppercase tracking-wide mb-4"
          >
            Quick Actions
          </h4>
          <div class="space-y-2">
            <a
              href="/journal"
              class="flex items-center gap-3 p-3 rounded-lg text-text-secondary hover:text-text-primary hover:bg-surface-tertiary transition-all duration-200"
            >
              <div class="w-2 h-2 bg-accent-400 rounded-full"></div>
              <span>View Latest Session</span>
            </a>
            <a
              href="/characters"
              class="flex items-center gap-3 p-3 rounded-lg text-text-secondary hover:text-text-primary hover:bg-surface-tertiary transition-all duration-200"
            >
              <div class="w-2 h-2 bg-info rounded-full"></div>
              <span>Browse Characters</span>
            </a>
            <a
              href="/campaign"
              class="flex items-center gap-3 p-3 rounded-lg text-text-secondary hover:text-text-primary hover:bg-surface-tertiary transition-all duration-200"
            >
              <div class="w-2 h-2 bg-success rounded-full"></div>
              <span>View Active Quests</span>
            </a>
            <a
              href="/atlas"
              class="flex items-center gap-3 p-3 rounded-lg text-text-secondary hover:text-text-primary hover:bg-surface-tertiary transition-all duration-200"
            >
              <div class="w-2 h-2 bg-gold-400 rounded-full"></div>
              <span>Explore Atlas</span>
            </a>
          </div>
        </div>
      </div>

      <div class="mt-6 text-center">
        <p class="text-sm text-text-muted">
          Press <kbd
            class="px-2 py-1 bg-surface-tertiary border border-border-primary rounded text-xs"
            >ESC</kbd
          > to close
        </p>
      </div>
    </div>
  </div>
</header>

<script>
  // Mobile menu functionality
  const mobileMenuTrigger = document.getElementById("mobile-menu-trigger");
  const mobileMenu = document.getElementById("mobile-menu");

  if (mobileMenuTrigger && mobileMenu) {
    mobileMenuTrigger.addEventListener("click", () => {
      mobileMenu.classList.toggle("hidden");
    });
  }

  // Search functionality
  const searchTrigger = document.getElementById("search-trigger");
  const searchOverlay = document.getElementById("search-overlay");
  const searchClose = document.getElementById("search-close");
  const searchInput = document.getElementById(
    "search-input"
  ) as HTMLInputElement;

  if (searchTrigger && searchOverlay) {
    searchTrigger.addEventListener("click", () => {
      searchOverlay.classList.remove("hidden");
      setTimeout(() => searchInput?.focus(), 100);
    });
  }

  if (searchClose && searchOverlay) {
    searchClose.addEventListener("click", () => {
      searchOverlay.classList.add("hidden");
    });
  }

  if (searchOverlay) {
    searchOverlay.addEventListener("click", (e) => {
      if (e.target === searchOverlay) {
        searchOverlay.classList.add("hidden");
      }
    });
  }

  // Escape key functionality
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (searchOverlay && !searchOverlay.classList.contains("hidden")) {
        searchOverlay.classList.add("hidden");
      }
      if (mobileMenu && !mobileMenu.classList.contains("hidden")) {
        mobileMenu.classList.add("hidden");
      }
    }
  });

  // Search form functionality
  const searchForm = document.getElementById("search-form");
  if (searchForm && searchInput) {
    searchForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query) {
        console.log("Searching for:", query);
        // TODO: Implement actual search functionality
        // For now, could redirect to a search results page
        // window.location.href = `/search?q=${encodeURIComponent(query)}`;
      }
    });
  }

  // Header scroll behavior
  let lastScrollY = 0;
  let isScrolled = false;
  const header = document.querySelector("header");

  function handleScroll() {
    const currentScrollY = window.scrollY;

    // Update scrolled state for styling
    if (currentScrollY > 10 && !isScrolled) {
      isScrolled = true;
      header?.classList.add("shadow-lg");
    } else if (currentScrollY <= 10 && isScrolled) {
      isScrolled = false;
      header?.classList.remove("shadow-lg");
    }

    lastScrollY = currentScrollY;
  }

  // Throttle scroll handler
  let ticking = false;
  function throttledScrollHandler() {
    if (!ticking) {
      requestAnimationFrame(() => {
        handleScroll();
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener("scroll", throttledScrollHandler);
</script>

<style>
  /* Mobile menu animations */
  #mobile-menu {
    animation: slideDown 0.2s ease-out;
  }

  #mobile-menu.hidden {
    animation: slideUp 0.2s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideUp {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  /* Search overlay animations */
  #search-overlay {
    animation: fadeIn 0.3s ease-out;
  }

  #search-overlay.hidden {
    animation: fadeOut 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  /* Custom scrollbar for mobile menu */
  #mobile-menu nav {
    scrollbar-width: thin;
    scrollbar-color: rgb(var(--border-primary)) transparent;
  }

  #mobile-menu nav::-webkit-scrollbar {
    width: 4px;
  }

  #mobile-menu nav::-webkit-scrollbar-track {
    background: transparent;
  }

  #mobile-menu nav::-webkit-scrollbar-thumb {
    background: rgb(var(--border-primary));
    border-radius: 2px;
  }
</style>
